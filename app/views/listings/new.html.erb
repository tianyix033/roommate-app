<% content_for :title, "Create Listing" %>
<% content_for :content_class, "max-w-2xl mx-auto" %>

<style>
  .image-upload-zone {
    border: 2px dashed rgba(255, 255, 255, 0.2);
    transition: all 0.2s ease;
  }
  .image-upload-zone:hover,
  .image-upload-zone.dragover {
    border-color: rgba(255, 252, 0, 0.5);
    background-color: rgba(255, 252, 0, 0.05);
  }
  .image-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
  }
  .image-preview-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 0.75rem;
    overflow: hidden;
  }
  .image-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .image-preview-remove {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  .image-preview-remove:hover {
    background: rgba(239, 68, 68, 0.9);
  }
</style>

<!-- Header -->
<div class="mb-6 opacity-0 animate-fadeIn">
  <a href="javascript:history.back()" class="inline-flex items-center gap-2 text-gray-400 hover:text-white transition-colors text-sm mb-4">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
    Back
  </a>
  <h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-2">Create New Listing</h1>
  <p class="text-gray-400">Share your space with potential roommates</p>
</div>

<!-- Form -->
<div class="glass-card rounded-2xl p-6 opacity-0 animate-fadeIn" style="animation-delay: 0.1s;">
  <%= form_with(model: @listing, local: true, html: { multipart: true }, class: "space-y-5") do |form| %>
  <% if @listing.errors.any? %>
      <div class="px-4 py-3 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400">
        <h3 class="font-semibold mb-2"><%= pluralize(@listing.errors.count, "error") %> prohibited this listing from being saved:</h3>
        <ul class="list-disc list-inside text-sm space-y-1">
        <% @listing.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

    <div>
      <%= form.label :title, "Title", class: "block text-sm font-medium text-gray-300 mb-2" %>
      <%= form.text_field :title, 
          class: "w-full px-4 py-2.5 rounded-xl bg-gray-900 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#FFFC00]/50 focus:border-transparent transition-all duration-200",
          placeholder: "e.g. Cozy Studio in Downtown" %>
  </div>

    <div>
      <%= form.label :description, "Description", class: "block text-sm font-medium text-gray-300 mb-2" %>
      <%= form.text_area :description, 
          rows: 3,
          class: "w-full px-4 py-2.5 rounded-xl bg-gray-900 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#FFFC00]/50 focus:border-transparent transition-all duration-200 resize-none",
          placeholder: "Describe your space, amenities, and ideal roommate..." %>
  </div>

    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <%= form.label :price, "Monthly Price ($)", class: "block text-sm font-medium text-gray-300 mb-2" %>
        <%= form.number_field :price, 
            step: 0.01,
            class: "w-full px-4 py-2.5 rounded-xl bg-gray-900 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#FFFC00]/50 focus:border-transparent transition-all duration-200",
            placeholder: "1500" %>
  </div>

      <div>
        <%= form.label :city, "City", class: "block text-sm font-medium text-gray-300 mb-2" %>
        <div class="relative">
          <%= form.text_field :city, 
              id: "city-input-new",
              class: "w-full px-4 py-2.5 rounded-xl bg-gray-900 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#FFFC00]/50 focus:border-transparent transition-all duration-200",
              placeholder: "New York",
              autocomplete: "off" %>
          <div id="city-autocomplete-new" class="absolute z-50 w-full mt-1 bg-gray-800 border border-white/10 rounded-xl shadow-lg hidden max-h-60 overflow-y-auto"></div>
        </div>
      </div>

      <div>
        <%= form.label :owner_email, "Contact Email", class: "block text-sm font-medium text-gray-300 mb-2" %>
        <%= form.email_field :owner_email, 
            class: "w-full px-4 py-2.5 rounded-xl bg-gray-900 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#FFFC00]/50 focus:border-transparent transition-all duration-200",
            placeholder: "you@example.com" %>
      </div>
  </div>

    <!-- Image Upload Section -->
    <div>
      <%= form.label :images, "Listing Images", class: "block text-sm font-medium text-gray-300 mb-2" %>
      <p class="text-xs text-gray-500 mb-3">Upload up to <%= Listing::MAX_IMAGES %> images (JPEG, PNG, WebP, GIF - max 5MB each)</p>
      
      <div id="image-upload-zone" class="image-upload-zone rounded-xl p-6 text-center cursor-pointer">
        <input type="file" 
               id="image-input" 
               name="listing[images][]" 
               multiple 
               accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
               class="hidden">
        <div class="pointer-events-none">
          <svg class="w-10 h-10 mx-auto text-gray-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <p class="text-gray-400 text-sm">Click to upload or drag and drop</p>
          <p id="image-count" class="text-gray-500 text-xs mt-1">0/<%= Listing::MAX_IMAGES %> images</p>
        </div>
      </div>
      
      <!-- Image Preview Grid -->
      <div id="image-preview-container" class="image-preview-grid mt-4 hidden"></div>
    </div>

    <div class="pt-2">
      <%= form.submit "Create Listing", 
          class: "w-full px-6 py-3 text-base font-semibold rounded-full bg-white text-black hover:bg-gray-200 transition-all duration-200 cursor-pointer" %>
  </div>
<% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const uploadZone = document.getElementById('image-upload-zone');
  const imageInput = document.getElementById('image-input');
  const previewContainer = document.getElementById('image-preview-container');
  const imageCount = document.getElementById('image-count');
  const maxImages = <%= Listing::MAX_IMAGES %>;
  
  let selectedFiles = new DataTransfer();
  
  // Click to upload
  uploadZone.addEventListener('click', () => imageInput.click());
  
  // Drag and drop
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
  });
  
  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
  });
  
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });
  
  // File input change
  imageInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });
  
  function handleFiles(files) {
    const currentCount = selectedFiles.files.length;
    const availableSlots = maxImages - currentCount;
    
    if (availableSlots <= 0) {
      alert(`Maximum ${maxImages} images allowed`);
      return;
    }
    
    const filesToAdd = Array.from(files).slice(0, availableSlots);
    
    filesToAdd.forEach(file => {
      if (file.type.startsWith('image/')) {
        selectedFiles.items.add(file);
        addPreview(file, selectedFiles.files.length - 1);
      }
    });
    
    imageInput.files = selectedFiles.files;
    updateCount();
  }
  
  function addPreview(file, index) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const div = document.createElement('div');
      div.className = 'image-preview-item';
      div.dataset.index = index;
      div.innerHTML = `
        <img src="${e.target.result}" alt="Preview">
        <button type="button" class="image-preview-remove" onclick="removeImage(${index})">
          <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
      previewContainer.appendChild(div);
      previewContainer.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
  
  window.removeImage = function(index) {
    const newFiles = new DataTransfer();
    Array.from(selectedFiles.files).forEach((file, i) => {
      if (i !== index) {
        newFiles.items.add(file);
      }
    });
    selectedFiles = newFiles;
    imageInput.files = selectedFiles.files;
    
    // Rebuild previews
    previewContainer.innerHTML = '';
    Array.from(selectedFiles.files).forEach((file, i) => addPreview(file, i));
    
    if (selectedFiles.files.length === 0) {
      previewContainer.classList.add('hidden');
    }
    updateCount();
  };
  
  function updateCount() {
    imageCount.textContent = `${selectedFiles.files.length}/${maxImages} images`;
  }
});
(function() {
  const cityInput = document.getElementById('city-input-new');
  const autocompleteDiv = document.getElementById('city-autocomplete-new');
  let debounceTimer;
  let selectedIndex = -1;
  
  if (!cityInput || !autocompleteDiv) return;
  
  cityInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(debounceTimer);
    
    if (query.length < 2) {
      autocompleteDiv.classList.add('hidden');
      return;
    }
    
    debounceTimer = setTimeout(() => {
      fetch(`/cities/autocomplete?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(cities => {
          const safeCities = (cities || []).filter(city => city && !city.includes('%s'));

          if (safeCities.length === 0) {
            autocompleteDiv.classList.add('hidden');
            return;
          }

          autocompleteDiv.innerHTML = '';
          const fragment = document.createDocumentFragment();

          safeCities.forEach((city, index) => {
            const option = document.createElement('div');
            option.className = `city-option px-4 py-2 cursor-pointer hover:bg-white/10 text-white ${index === 0 ? 'bg-white/5' : ''}`;
            option.dataset.city = city;
            option.dataset.index = index;
            option.textContent = city; // use textContent to avoid injecting HTML from API
            option.addEventListener('click', function() {
              cityInput.value = this.dataset.city;
              autocompleteDiv.classList.add('hidden');
            });
            fragment.appendChild(option);
          });

          autocompleteDiv.appendChild(fragment);
          autocompleteDiv.classList.remove('hidden');
          selectedIndex = 0;
          updateSelection(autocompleteDiv.querySelectorAll('.city-option'));
        })
        .catch(() => {
          autocompleteDiv.classList.add('hidden');
        });
    }, 300);
  });
  
  cityInput.addEventListener('keydown', function(e) {
    const options = autocompleteDiv.querySelectorAll('.city-option');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, options.length - 1);
      updateSelection(options);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(options);
    } else if (e.key === 'Enter' && options.length > 0) {
      e.preventDefault();
      const target = options[selectedIndex >= 0 ? selectedIndex : 0];
      target.click();
    } else if (e.key === 'Escape') {
      autocompleteDiv.classList.add('hidden');
    }
  });
  
  function updateSelection(options) {
    options.forEach((opt, idx) => {
      opt.classList.toggle('bg-white/5', idx === selectedIndex);
    });
  }
  
  // Hide autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!cityInput.contains(e.target) && !autocompleteDiv.contains(e.target)) {
      autocompleteDiv.classList.add('hidden');
    }
  });
})();
</script>
