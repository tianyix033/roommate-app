<% content_for :title, @listing.title %>
<% content_for :content_class, "max-w-4xl mx-auto" %>

<style>
  .image-gallery-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  @media (min-width: 640px) {
    .image-gallery-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  .gallery-image-item {
    position: relative;
    aspect-ratio: 4/3;
    border-radius: 0.75rem;
    overflow: hidden;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.05);
  }
  .gallery-image-item:first-child {
    grid-column: span 2;
    grid-row: span 2;
  }
  @media (min-width: 640px) {
    .gallery-image-item:first-child {
      grid-column: span 2;
      grid-row: span 2;
    }
  }
  .gallery-image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  .gallery-image-item:hover img {
    transform: scale(1.05);
  }
  .gallery-primary-badge {
    position: absolute;
    bottom: 0.5rem;
    left: 0.5rem;
    background: linear-gradient(135deg, #FFFC00, #FFD700);
    color: black;
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  /* Lightbox styles */
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 50;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .lightbox.active {
    display: flex;
  }
  .lightbox-image {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 0.5rem;
  }
  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  .lightbox-prev {
    left: 1rem;
  }
  .lightbox-next {
    right: 1rem;
  }
  .lightbox-counter {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 0.875rem;
  }
</style>

<!-- Back button -->
<div class="mb-6 opacity-0 animate-fadeIn">
  <a href="<%= listings_path %>" class="inline-flex items-center gap-2 text-gray-400 hover:text-white transition-colors text-sm">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
    Back to listings
  </a>
</div>

<!-- Listing Card -->
<div class="glass-card rounded-2xl p-8 opacity-0 animate-fadeIn" style="animation-delay: 0.1s;">
  <!-- Header -->
  <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
    <div>
      <div class="flex items-center gap-3 mb-2">
        <% if @listing.status == 'verified' %>
          <span class="flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500 text-white text-xs font-semibold">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Verified
          </span>
        <% elsif @listing.status == 'pending' %>
          <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-500/10 text-gray-400 border border-gray-500/20">Pending</span>
        <% elsif @listing.status == 'rejected' %>
          <span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-500/10 text-red-400 border border-red-500/20">Rejected</span>
        <% else %>
          <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-500/10 text-gray-400 border border-gray-500/20">Pending</span>
        <% end %>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-white"><%= @listing.title %></h1>
    </div>
    <div class="text-right">
      <p class="text-3xl md:text-4xl font-bold text-white">$<%= number_with_precision(@listing.price, precision: 1) %></p>
      <p class="text-gray-400 text-sm">per month</p>
    </div>
  </div>

  <!-- Location -->
  <div class="flex items-center gap-2 text-gray-400 mb-6 pb-6 border-b border-white/10">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
    </svg>
    <span class="text-lg"><%= @listing.city %></span>
  </div>

  <% if @listing.images.attached? %>
  <!-- Image Gallery -->
  <div class="mb-8">
    <h2 class="text-lg font-semibold text-white mb-4">Photos</h2>
    <div class="image-gallery-grid">
      <% @listing.ordered_images.each_with_index do |image, index| %>
        <div class="gallery-image-item" onclick="openLightbox(<%= index %>)">
          <%= image_tag url_for(image), alt: "#{@listing.title} - Photo #{index + 1}" %>
          <% if index == 0 && @listing.primary_image_id.present? %>
            <span class="gallery-primary-badge">Primary</span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <% end %>

  <!-- Description -->
  <div class="mb-8">
    <h2 class="text-lg font-semibold text-white mb-3">Description</h2>
    <p class="text-gray-300 leading-relaxed"><%= @listing.description %></p>
  </div>

  <!-- Contact Info -->
  <div class="p-4 rounded-xl bg-white/5 mb-8">
    <h2 class="text-lg font-semibold text-white mb-2">Contact</h2>
    <div class="flex items-center gap-2 text-gray-300">
      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
      <a href="mailto:<%= @listing.owner_email %>" class="hover:text-[#FFFC00] transition-colors"><%= @listing.owner_email %></a>
    </div>
  </div>

  <!-- Actions -->
  <div class="flex flex-wrap items-center gap-3 pt-6 border-t border-white/10">
    <%= link_to edit_listing_path(@listing), class: "inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold rounded-full bg-white text-black hover:bg-gray-200 transition-colors duration-200" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
      Edit Listing
<% end %>

    <%= button_to listing_path(@listing), method: :delete, data: { turbo_confirm: 'Are you sure you want to delete this listing?' }, class: "inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold rounded-full text-white hover:opacity-80 transition-opacity duration-200", style: "background-color: oklch(75% 0.183 55.934);" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
      </svg>
      Delete Listing
    <% end %>

<% if @listing.verification_requested && !@listing.verified %>
      <%= button_to verify_listing_path(@listing), method: :patch, class: "inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold rounded-full bg-green-500/20 text-green-400 border border-green-500/30 hover:bg-green-500/30 transition-colors duration-200" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Mark as Verified
      <% end %>
<% end %>
  </div>
</div>

<% if @listing.images.attached? %>
<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
  <button class="lightbox-close" onclick="closeLightbox(event)">
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>
  <button class="lightbox-nav lightbox-prev" onclick="prevImage(event)">
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
  </button>
  <img id="lightbox-image" class="lightbox-image" src="" alt="Listing image">
  <button class="lightbox-nav lightbox-next" onclick="nextImage(event)">
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
    </svg>
  </button>
  <div class="lightbox-counter">
    <span id="lightbox-current">1</span> / <span id="lightbox-total"><%= @listing.images.count %></span>
  </div>
</div>

<script>
  const imageUrls = [
    <% @listing.ordered_images.each do |image| %>
      "<%= url_for(image) %>",
    <% end %>
  ];
  
  let currentIndex = 0;
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.getElementById('lightbox-image');
  const lightboxCurrent = document.getElementById('lightbox-current');
  
  function openLightbox(index) {
    currentIndex = index;
    updateLightboxImage();
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  
  function closeLightbox(event) {
    if (event.target === lightbox || event.currentTarget.classList.contains('lightbox-close')) {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }
  }
  
  function prevImage(event) {
    event.stopPropagation();
    currentIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
    updateLightboxImage();
  }
  
  function nextImage(event) {
    event.stopPropagation();
    currentIndex = (currentIndex + 1) % imageUrls.length;
    updateLightboxImage();
  }
  
  function updateLightboxImage() {
    lightboxImage.src = imageUrls[currentIndex];
    lightboxCurrent.textContent = currentIndex + 1;
  }
  
  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('active')) return;
    
    if (e.key === 'Escape') {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    } else if (e.key === 'ArrowLeft') {
      currentIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
      updateLightboxImage();
    } else if (e.key === 'ArrowRight') {
      currentIndex = (currentIndex + 1) % imageUrls.length;
      updateLightboxImage();
    }
  });
</script>
<% end %>
